# SPDX-FileCopyrightText: 2023 - 2026 UnionTech Software Technology Co., Ltd.
#
# SPDX-License-Identifier: GPL-3.0-or-later

version: "1"

package:
  id: org.deepin.camera
  name: "deepin-camera"
  version: 6.5.38.1
  kind: app
  description: |
    camera for deepin os.

base: org.deepin.base/25.2.2
runtime: org.deepin.runtime.dtk/25.2.2

command:
  - deepin-camera

build: |
  # 下载和安装依赖
  apt -y install --download-only qt6-base-dev libdtk6gui-dev libdtk6widget-dev qt6-multimedia-dev libavutil-dev libavformat-dev libavcodec-dev libavfilter-dev qt6-tools-dev qt6-tools-dev-tools deepin-gettext-tools qt6-svg-dev libv4l-dev libsdl2-dev portaudio19-dev libpng-dev libasound2-dev libpciaccess-dev libusb-1.0-0-dev zlib1g-dev libudev-dev libswscale-dev libswresample-dev libffmpegthumbnailer-dev libx11-dev libva-dev libimageeditor6-dev libimageeditor6 libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev gstreamer1.0-plugins-good deepin-event-log
  bash ./install_dep /var/cache/apt/archives "$PREFIX"

  # 移动部分库到应用库目录，否则无法找到
  mv ${PREFIX}/lib/${TRIPLET}/blas/* ${PREFIX}/lib/${TRIPLET}
  mv ${PREFIX}/lib/${TRIPLET}/lapack/* ${PREFIX}/lib/${TRIPLET}
  ldconfig -C "$LINGLONG_LD_SO_CACHE"

  # 修改路径
  find src -type f -name "*.service" -exec sed -i 's|^Exec=.*|Exec=deepin-camera|g' {} +

  # 构建
  VERSION=$(head -1 debian/changelog | awk -F'[()]' '{print $2}')
  cmake -B build ${conf_args} \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=${PREFIX} \
        -DCMAKE_INSTALL_LIBDIR=${PREFIX}/lib/${TRIPLET} \
        -DVERSION=${VERSION} \
        -DLINGLONG_BUILD_ON=1
  cmake --build build -j`nproc`
  cmake --build build --target install > install.log 2>&1

  # 项目生成应用名和动态隐式加载的依赖库，ldd无法找到的其他库
  LDD_FILES=(
    deepin-camera
    libv4l2.so
    libportaudio.so
    libusb-1.0.so
    # 已包含在 runtime 中
    # libudev.so
    libavutil.so
    libavformat.so
    libswscale.so
    libswresample.so
    libffmpegthumbnailer.so
    libavcodec.so
    ../libdeepin-event-log.so
  )

  # 生成.install 文件
  bash ./deploy_dep "${LDD_FILES[@]}"

  # Add resource files from libimageeditor (any version)
  ID_VALUE=$(awk -F ': ' '/^  id: / {print $2}' linglong.yaml)

  echo "=== QT Version Detection ===" >&2
  if [ -z "$QT_VERSION_MAJOR" ]; then
      if command -v qmake >/dev/null 2>&1; then
          QT_VERSION=$(qmake -query QT_VERSION 2>/dev/null || echo "unknown")
          QT_MAJOR=$(qmake -query QT_VERSION 2>/dev/null | cut -d. -f1 || echo "6")
          echo "Using QT_MAJOR from qmake: $QT_MAJOR" >&2
      else
          QT_MAJOR=6  # default value
          echo "qmake not found, using default QT_MAJOR: $QT_MAJOR" >&2
      fi
  else
      QT_MAJOR=$QT_VERSION_MAJOR
      echo "Using QT_MAJOR from environment: $QT_MAJOR" >&2
  fi

  version=$QT_MAJOR
  lib_path="${PREFIX}/share/libimagevisualresult${version}"
  echo "Full library path: $lib_path" >&2
  find "$lib_path" >> "${ID_VALUE}.install"
  echo "================================"

# allow apt download in build and do apt update
buildext:
  apt:
    build_depends:
      - libc6
